"use strict";var ge=Object.create;var P=Object.defineProperty;var ce=Object.getOwnPropertyDescriptor;var pe=Object.getOwnPropertyNames;var le=Object.getPrototypeOf,de=Object.prototype.hasOwnProperty;var A=(t,e)=>{for(var n in e)P(t,n,{get:e[n],enumerable:!0})},E=(t,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of pe(e))!de.call(t,s)&&s!==n&&P(t,s,{get:()=>e[s],enumerable:!(i=ce(e,s))||i.enumerable});return t},c=(t,e,n)=>(E(t,e,"default"),n&&E(n,e,"default")),_=(t,e,n)=>(n=t!=null?ge(le(t)):{},E(e||!t||!t.__esModule?P(n,"default",{value:t,enumerable:!0}):n,t)),ue=t=>E(P({},"__esModule",{value:!0}),t);var T={};A(T,{Bot:()=>U,BotSpecificClient:()=>b,Integration:()=>M,IntegrationDefinition:()=>y,IntegrationSpecificClient:()=>I,RuntimeError:()=>D.RuntimeError,botIdHeader:()=>v,botUserIdHeader:()=>O,configurationHeader:()=>C,integrationIdHeader:()=>H,isApiError:()=>D.isApiError,messages:()=>k,operationHeader:()=>x,parseBody:()=>u,serve:()=>S,studioComponentDefinitions:()=>K,typeHeader:()=>j,webhookIdHeader:()=>R});module.exports=ue(T);var k={};A(k,{defaults:()=>Ie});var a={};A(a,{default:()=>Te,studioComponentDefinitions:()=>K});var o=require("@bpinternal/zui");c(a,require("@bpinternal/zui"));var d=o.z.object({allowDynamicVariable:o.z.boolean().optional(),horizontal:o.z.boolean().optional()}),K={string:{text:{id:"text",params:d.extend({multiLine:o.z.boolean().optional(),growVertically:o.z.boolean().optional(),suggestions:o.z.array(o.z.string()).optional()})},dropdown:{id:"dropdown",params:d.extend({filterable:o.z.boolean().optional()})},radiogroup:{id:"radiogroup",params:d.extend({})},date:{id:"date",params:d.extend({dateFormat:o.z.string().optional(),minDate:o.z.string().optional(),maxDate:o.z.string().optional(),defaultTimezone:o.z.string().optional(),disableTimezoneSelection:o.z.boolean().optional(),highlightCurrentDay:o.z.boolean().optional(),showShortcutButtons:o.z.boolean().optional(),showOutsideDaysOfMonth:o.z.boolean().optional(),firstDayOfWeek:o.z.number().optional(),canChangeMonth:o.z.boolean().optional(),showWeekNumbers:o.z.boolean().optional()})},time:{id:"time",params:d.extend({useAMPM:o.z.boolean().optional(),timeFormat:o.z.string().optional(),minTime:o.z.string().optional(),maxTime:o.z.string().optional(),showArrowButtons:o.z.boolean().optional(),precision:o.z.enum(["minute","second","millisecond"]).optional()})},richtext:{id:"richtext",params:o.z.object({allowDynamicVariable:o.z.boolean().optional(),resizable:o.z.boolean().optional()})},json:{id:"json",params:d.extend({showPreview:o.z.boolean().optional(),showValidationError:o.z.boolean().optional()})},file:{id:"file",params:d.extend({fileTypes:o.z.array(o.z.enum(["image","audio","video"])).optional(),showUploadedFiles:o.z.boolean().optional()})}},number:{number:{id:"number",params:d.extend({allowNumericCharactersOnly:o.z.boolean().optional(),stepSize:o.z.number().optional()})},slider:{id:"slider",params:o.z.object({horizontal:o.z.boolean().optional(),stepSize:o.z.number().optional()})}},boolean:{switch:{id:"switch",params:d}},array:{options:{id:"options",params:d},strings:{id:"strings",params:d},daterange:{id:"daterange",params:o.z.object({dateFormat:o.z.string().optional(),minDate:o.z.string().optional(),maxDate:o.z.string().optional(),defaultTimezone:o.z.string().optional(),allowSingleDayRange:o.z.boolean().optional(),highlightCurrentDay:o.z.boolean().optional(),showOutsideDaysOfMonth:o.z.boolean().optional(),firstDayOfWeek:o.z.number().optional(),canChangeMonth:o.z.boolean().optional(),showWeekNumbers:o.z.boolean().optional()})}},object:{collapsible:{id:"collapsible",params:o.z.object({defaultOpen:o.z.boolean().optional()})},modal:{id:"modal",params:o.z.object({title:o.z.string().optional(),buttonLabel:o.z.string().optional(),closeButtonLabel:o.z.string().optional()})},popover:{id:"popover",params:o.z.object({buttonLabel:o.z.string().optional()})}},discriminatedUnion:{}},Te=o.z;var p=a.z.string().min(1),z=a.z.object({text:p}),N=a.z.object({markdown:p}),W=a.z.object({imageUrl:p}),$=a.z.object({audioUrl:p}),Z=a.z.object({videoUrl:p}),J=a.z.object({fileUrl:p,title:p.optional()}),V=a.z.object({latitude:a.z.number(),longitude:a.z.number(),address:a.z.string().optional(),title:a.z.string().optional()}),Q=a.z.object({title:p,subtitle:p.optional(),imageUrl:p.optional(),actions:a.z.array(a.z.object({action:a.z.enum(["postback","url","say"]),label:p,value:p}))}),q=a.z.object({text:p,options:a.z.array(a.z.object({label:p,value:p}))}),me=a.z.object({items:a.z.array(Q)}),he=a.z.discriminatedUnion("type",[a.z.object({type:a.z.literal("text"),payload:z}),a.z.object({type:a.z.literal("markdown"),payload:N}),a.z.object({type:a.z.literal("image"),payload:W}),a.z.object({type:a.z.literal("audio"),payload:$}),a.z.object({type:a.z.literal("video"),payload:Z}),a.z.object({type:a.z.literal("file"),payload:J}),a.z.object({type:a.z.literal("location"),payload:V})]),ye=a.z.object({items:a.z.array(he)}),Ie={text:{schema:z},markdown:{schema:N},image:{schema:W},audio:{schema:$},video:{schema:Z},file:{schema:J},location:{schema:V},carousel:{schema:me},card:{schema:Q},dropdown:{schema:q},choice:{schema:q},bloc:{schema:ye}};var v="x-bot-id",O="x-bot-user-id",H="x-integration-id",R="x-webhook-id",C="x-bp-configuration",x="x-bp-operation",j="x-bp-type";var X=require("node:http");var h=console;function u(t){if(!t.body)throw new Error("Missing body");return JSON.parse(t.body)}async function S(t,e=8072,n=ve){let i=(0,X.createServer)(async(s,r)=>{try{let g=await fe(s);if(g.path==="/health"){r.writeHead(200).end("ok");return}let l=await t(g);r.writeHead(l?.status??200,l?.headers??{}).end(l?.body??"{}")}catch(g){h.error("Error while handling request",{error:g?.message??"Internal error occured"}),r.writeHead(500).end(JSON.stringify({error:g?.message??"Internal error occured"}))}});return i.listen(e,()=>n(e)),i}async function fe(t){let e=await Be(t),n={};for(let s=0;s<t.rawHeaders.length;s+=2){let r=t.rawHeaders[s].toLowerCase(),g=t.rawHeaders[s+1];n[r]=g}let i=new URL(t.url??"",t.headers.host?`http://${t.headers.host}`:"http://botpress.cloud");return{body:e,path:i.pathname,query:be(i.search,"?"),headers:n,method:t.method?.toUpperCase()??"GET"}}function be(t,e){return t.indexOf(e)===0?t.slice(e.length):t}async function Be(t){return new Promise((e,n)=>{if(t.method!=="POST"&&t.method!=="PUT"&&t.method!=="PATCH")return e(void 0);let i="";t.on("data",s=>i+=s.toString()),t.on("error",s=>n(s)),t.on("end",()=>e(i))})}function ve(t){h.info(`Listening on port ${t}`)}c(T,a,module.exports);var D=require("@botpress/client");var Y=require("@bpinternal/zui");var Ce=Y.z.enum(["webhook_received","message_created","action_triggered","register","unregister","ping","create_user","create_conversation"]),ee=t=>{let e=t[v],n=t[O],i=t[H],s=t[R],r=t[C],g=Ce.parse(t[x]);if(!e)throw new Error("Missing bot headers");if(!n)throw new Error("Missing bot user headers");if(!i)throw new Error("Missing integration headers");if(!s)throw new Error("Missing webhook headers");if(!r)throw new Error("Missing configuration headers");if(!g)throw new Error("Missing operation headers");return{botId:e,botUserId:n,integrationId:i,webhookId:s,operation:g,configuration:r?JSON.parse(Buffer.from(r,"base64").toString("utf-8")):{}}};var y=class{constructor(e){this.props=e;this.name=e.name,this.version=e.version,this.icon=e.icon,this.readme=e.readme,this.title=e.title,this.identifier=e.identifier,this.description=e.description,this.configuration=e.configuration,this.events=e.events,this.actions=e.actions,this.channels=e.channels,this.states=e.states,this.user=e.user,this.secrets=e.secrets,this.entities=e.entities}name;version;title;description;icon;readme;configuration;events;actions;channels;states;user;secrets;identifier;entities;clone(e){return new y({...this,...e})}};var f=require("@botpress/client");var I=class{constructor(e){this.client=e}createConversation=e=>this.client.createConversation(e);getConversation=e=>this.client.getConversation(e);listConversations=e=>this.client.listConversations(e);getOrCreateConversation=e=>this.client.getOrCreateConversation(e);updateConversation=e=>this.client.updateConversation(e);deleteConversation=e=>this.client.deleteConversation(e);listParticipants=e=>this.client.listParticipants(e);addParticipant=e=>this.client.addParticipant(e);getParticipant=e=>this.client.getParticipant(e);removeParticipant=e=>this.client.removeParticipant(e);createEvent=e=>this.client.createEvent(e);getEvent=e=>this.client.getEvent(e);listEvents=e=>this.client.listEvents(e);createMessage=e=>this.client.createMessage(e);getOrCreateMessage=e=>this.client.getOrCreateMessage(e);getMessage=e=>this.client.getMessage(e);updateMessage=e=>this.client.updateMessage(e);listMessages=e=>this.client.listMessages(e);deleteMessage=e=>this.client.deleteMessage(e);createUser=e=>this.client.createUser(e);getUser=e=>this.client.getUser(e);listUsers=e=>this.client.listUsers(e);getOrCreateUser=e=>this.client.getOrCreateUser(e);updateUser=e=>this.client.updateUser(e);deleteUser=e=>this.client.deleteUser(e);getState=e=>this.client.getState(e);setState=e=>this.client.setState(e);getOrSetState=e=>this.client.getOrSetState(e);patchState=e=>this.client.patchState(e);configureIntegration=e=>this.client.configureIntegration(e)};var F=_(require("util")),w=t=>{if(process.env.BP_LOG_FORMAT==="json")return JSON.stringify({msg:F.default.format(...t),visible_to_bot_owner:!0});{let[e,...n]=t;return F.default.format(`[For Bot Owner] ${e}`,...n)}},te={forBot:()=>({info:(...t)=>{console.info(w(t))},warn:(...t)=>{console.warn(w(t))},error:(...t)=>{console.error(w(t))},debug:(...t)=>{console.debug(w(t))}})};var ne=t=>async e=>{let n=ee(e.headers),i=new I(new f.Client({botId:n.botId,integrationId:n.integrationId})),s={ctx:n,req:e,client:i,logger:te,instance:t};try{let r;switch(n.operation){case"webhook_received":r=await Se(s);break;case"register":r=await Ee(s);break;case"unregister":r=await Pe(s);break;case"message_created":r=await Ue(s);break;case"action_triggered":r=await De(s);break;case"ping":r=await xe(s);break;case"create_user":r=await we(s);break;case"create_conversation":r=await Me(s);break;default:throw new Error(`Unknown operation ${n.operation}`)}return r?{...r,status:r.status??200}:{status:200}}catch(r){if((0,f.isApiError)(r)){let g=new f.RuntimeError(r.message,r);return{status:g.code,body:JSON.stringify(g.toJSON())}}throw r}},xe=async t=>{},Se=async({client:t,ctx:e,req:n,logger:i,instance:s})=>{let{req:r}=u(n);return s.webhook({client:t,ctx:e,req:r,logger:i})},Ee=async({client:t,ctx:e,req:n,logger:i,instance:s})=>{if(!s.register)return;let{webhookUrl:r}=u(n);await s.register({client:t,ctx:e,webhookUrl:r,logger:i})},Pe=async({client:t,ctx:e,req:n,logger:i,instance:s})=>{if(!s.unregister)return;let{webhookUrl:r}=u(n);await s.unregister({ctx:e,webhookUrl:r,client:t,logger:i})},we=async({client:t,ctx:e,req:n,logger:i,instance:s})=>{if(!s.createUser)return;let{tags:r}=u(n);return await s.createUser({ctx:e,client:t,tags:r,logger:i})},Me=async({client:t,ctx:e,req:n,logger:i,instance:s})=>{if(!s.createConversation)return;let{channel:r,tags:g}=u(n);return await s.createConversation({ctx:e,client:t,channel:r,tags:g,logger:i})},Ue=async({ctx:t,req:e,client:n,logger:i,instance:s})=>{let{conversation:r,user:g,type:l,payload:B,message:m}=u(e),G=s.channels[r.channel];if(!G)throw new Error(`Channel ${r.channel} not found`);let L=G.messages[l];if(!L)throw new Error(`Message of type ${l} not found in channel ${r.channel}`);await L({ctx:t,conversation:r,message:m,user:g,type:l,client:n,payload:B,ack:async({tags:ie})=>{await n.updateMessage({id:m.id,tags:ie})},logger:i})},De=async({req:t,ctx:e,client:n,logger:i,instance:s})=>{let{input:r,type:g}=u(t);if(!g)throw new Error("Missing action type");let l=s.actions[g];if(!l)throw new Error(`Action ${g} not found`);let B=await l({ctx:e,input:r,client:n,type:g,logger:i});return{body:JSON.stringify({output:B})}};var M=class{props;actions;channels;register;unregister;createUser;createConversation;webhook;constructor(e){this.props=e,this.actions=e.actions,this.channels=e.channels,this.register=e.register,this.unregister=e.unregister,this.createUser=e.createUser,this.createConversation=e.createConversation,this.webhook=e.handler}handler=ne(this);start=e=>S(this.handler,e)};var ae=_(require("@botpress/client"));var b=class{constructor(e){this.client=e}getConversation=e=>this.client.getConversation(e);listConversations=e=>this.client.listConversations(e);updateConversation=e=>this.client.updateConversation(e);deleteConversation=e=>this.client.deleteConversation(e);listParticipants=e=>this.client.listParticipants(e);addParticipant=e=>this.client.addParticipant(e);getParticipant=e=>this.client.getParticipant(e);removeParticipant=e=>this.client.removeParticipant(e);getEvent=e=>this.client.getEvent(e);listEvents=e=>this.client.listEvents(e);createMessage=e=>this.client.createMessage(e);getOrCreateMessage=e=>this.client.getOrCreateMessage(e);getMessage=e=>this.client.getMessage(e);updateMessage=e=>this.client.updateMessage(e);listMessages=e=>this.client.listMessages(e);deleteMessage=e=>this.client.deleteMessage(e);getUser=e=>this.client.getUser(e);listUsers=e=>this.client.listUsers(e);updateUser=e=>this.client.updateUser(e);deleteUser=e=>this.client.deleteUser(e);getState=e=>this.client.getState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));setState=e=>this.client.setState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));getOrSetState=e=>this.client.getOrSetState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));patchState=e=>this.client.patchState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));callAction=e=>this.client.callAction(e);createConversation=e=>this.client.createConversation(e);getOrCreateConversation=e=>this.client.getOrCreateConversation(e);createUser=e=>this.client.createUser(e);getOrCreateUser=e=>this.client.getOrCreateUser(e)};var oe=require("@bpinternal/zui");var Ae=oe.z.enum(["event_received","register","unregister","ping","action_triggered"]),se=t=>{let e=t[v],n=t[C],i=t[j],s=Ae.parse(t[x]);if(!e)throw new Error("Missing bot headers");if(!i)throw new Error("Missing type headers");if(!n)throw new Error("Missing configuration headers");if(!s)throw new Error("Missing operation headers");return{botId:e,operation:s,type:i,configuration:n?JSON.parse(Buffer.from(n,"base64").toString("utf-8")):{}}};var re=t=>async e=>{let n=se(e.headers);n.operation!=="ping"&&h.info(`Received ${n.operation} operation for bot ${n.botId} of type ${n.type}`);let i=new b(new ae.Client({botId:n.botId})),s={req:e,ctx:n,client:i,instance:t};switch(n.operation){case"action_triggered":throw new Error(`Operation ${n.operation} not supported yet`);case"event_received":await Re(s);break;case"register":await Oe(s);break;case"unregister":await He(s);break;case"ping":await ke(s);break;default:throw new Error(`Unknown operation ${n.operation}`)}return{status:200}},ke=async t=>{},Oe=async t=>{},He=async t=>{},Re=async({ctx:t,req:e,client:n,instance:i})=>{h.debug(`Received event ${t.type}`);let s=u(e),r=s.event;switch(t.type){case"message_created":let g={user:r.payload.user,conversation:r.payload.conversation,message:r.payload.message,states:r.payload.states,event:r};await Promise.all(i.messageHandlers.map(m=>m({client:n,ctx:t,...g})));break;case"state_expired":let l={state:r.payload.state};await Promise.all(i.stateExpiredHandlers.map(m=>m({client:n,ctx:t,...l})));break;default:let B={event:s.event};await Promise.all(i.eventHandlers.map(m=>m({client:n,ctx:t,...B})))}};var U=class{_state={messageHandlers:[],eventHandlers:[],stateExpiredHandlers:[]};props;constructor(e){this.props=e}message=e=>{this._state.messageHandlers.push(e)};event=e=>{this._state.eventHandlers.push(e)};stateExpired=e=>{this._state.stateExpiredHandlers.push(e)};handler=re(this._state);start=e=>S(this.handler,e)};0&&(module.exports={Bot,BotSpecificClient,Integration,IntegrationDefinition,IntegrationSpecificClient,RuntimeError,botIdHeader,botUserIdHeader,configurationHeader,integrationIdHeader,isApiError,messages,operationHeader,parseBody,serve,studioComponentDefinitions,typeHeader,webhookIdHeader});
//# sourceMappingURL=index.js.map
